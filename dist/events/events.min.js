"use strict";const LIST_EVENTS_URL="/events",NEW_EVENT_URL="/events/new";angular.module("EventPlanner.events",["ngRoute","ngMaterial","ngMessages"]).config(["$routeProvider",function(e){e.when("/events",{templateUrl:"events/events.html",controller:"EventsCtrl"}),e.when("/events/new",{templateUrl:"events/newevent.html",controller:"NewEventsCtrl"}),e.when("/events/edit/:id",{templateUrl:"events/newevent.html",controller:"NewEventsCtrl"}),e.when("/events/guests/:id",{templateUrl:"events/guests.html",controller:"GuestsCtrl"})}]).factory("eventService",[function(){var e=this,t=angular.injector(["ng","EventPlanner.users"]);e.userService=t.get("userService"),e.storage=window.localStorage,e.LIST_EVENTS_URL="#/events",e.NEW_EVENT_URL="#/events/new",e.EVENTS_KEY="EVENTS",e.EVENT_ID_KEY="EVENT_ID";var n=function(t,r,s,a,i,o,d,v){n.id=n.id||0,this.id=e.getIdAndIncrement(),this.name=t,this.type=r,this.host=s,this.dateTimeStart=a,this.dateTimeEnd=i,this.guests=o,this.location=d,this.message=v};if(e.Event=n,e.getIdAndIncrement=function(){var t=e.latest_id++;return e.storage&&e.storage.setItem(e.EVENT_ID_KEY,e.latest_id),t},n.formats={time:"HH:MM Z",date:"DD/MM/YYYY"},n.eventTypes=["Birthday Party","Conference Talk","Wedding"],n.fromObject=function(e){return new n(e.name,e.type,e.host,e.dateTimeStart,e.dateTimeEnd,e.guests,e.location,e.message)},n.prototype.updateFromEvent=function(e){this.name=e.name,this.type=e.type,this.host=e.host,this.dateTimeStart=e.dateTimeStart,this.dateTimeEnd=e.dateTimeEnd,this.guests=e.guests,this.location=e.location,this.message=e.message},n.prototype.getStartDateString=function(){return moment(this.dateTimeStart).format(n.formats.date+" "+n.formats.time)},n.prototype.getEndDateString=function(){return moment(this.dateTimeEnd).format(n.formats.date+" "+n.formats.time)},e.storage){if(e.storage.key(e.EVENT_ID_KEY)?e.latest_id=JSON.parse(e.storage.getItem(e.EVENT_ID_KEY)):e.latest_id=0,e.storage.key(e.EVENTS_KEY)){var r=JSON.parse(e.storage.getItem(e.EVENTS_KEY));r&&(e.events=r.map(function(e){return new n.fromObject(e)}))}}else console.warn("No localStorage available");return e.events||(e.events=[new n("Another event","Another Type","AnHost",new Date("2016-03-06T15:35:00.991Z").getTime(),new Date("2016-03-06T15:40:00.300Z").getTime(),[],{address1:"Here",city:"London",postalCode:"E1"},"Yeah Yeah"),new n("An Event","One Type","Myself",new Date("2016-03-06T15:35:00.991Z").getTime(),new Date("2016-03-06T15:40:00.300Z").getTime(),[],{address1:"There",city:"London",postalCode:"S10"},"Yes please")]),e.addEvent=function(t){e.events.push(t),e.updateEvents()},e.updateEvents=function(){e.storage&&e.storage.setItem(e.EVENTS_KEY,JSON.stringify(e.events))},e.removeEvent=function(t){var n=e.events.findIndex(function(e){return e.name===t.name&&e.host===t.host});-1!=n&&(e.events.splice(n,1),e.updateEvents())},e.getEventById=function(t){return e.events.find(function(e){return e.id==t})},e}]).controller("EventsCtrl",["$scope","eventService",function(e,t){e.events=t.events,e.deleteEvent=t.removeEvent}]).controller("NewEventsCtrl",["$scope","eventService","$window","$routeParams",function(e,t,n,r){if(e.formats=t.Event.formats,e.isEdit=function(){return!!r.id},e.isEdit()){var s=t.getEventById(r.id);s?(e.event=angular.copy(s),e.event.dateStart=new Date(moment(s.dateTimeStart).format(t.Event.formats.date)),e.event.timeStart=new Date(moment(s.dateTimeStart).format(t.Event.formats.date+" "+t.Event.formats.time)),e.event.dateEnd=new Date(moment(s.dateTimeEnd).format(t.Event.formats.date)),e.event.timeEnd=new Date(moment(s.dateTimeEnd).format(t.Event.formats.date+" "+t.Event.formats.time))):n.location.href=t.LIST_EVENTS_URL}else e.event=null;e.eventTypes=t.Event.eventTypes;var a=function(){var t=angular.copy(e.event.dateStart),n=angular.copy(e.event.timeStart);return t.setHours(n.getHours()),t.setMinutes(n.getMinutes()),t},i=function(){var t=angular.copy(e.event.dateEnd),n=angular.copy(e.event.timeEnd);return t.setHours(n.getHours()),t.setMinutes(n.getMinutes()),t};e.verifyDates=function(){var t=e.event.dateStart,n=e.event.timeStart,r=e.event.dateEnd,s=e.event.timeEnd;if(t&&r&&n&&s){var o=moment(a().getTime()),d=moment(i().getTime());e.eventForm.endtime.$setValidity("startvalid",o.isValid()),e.eventForm.endtime.$setValidity("endvalid",d.isValid());var v=o.isValid()&&d.isValid()&&d.isAfter(o);return e.eventForm.endtime.$setValidity("after",v),v}},e.submitForm=function(){if(e.verifyDates()){var s=new t.Event(e.event.name,e.event.type,e.event.host,a().getTime(),i().getTime(),[],e.event.location,e.event.message);e.isEdit()?(t.getEventById(r.id).updateFromEvent(s),t.updateEvents()):t.addEvent(s),n.location.href=t.LIST_EVENTS_URL}}}]).controller("GuestsCtrl",["eventService","$window","$routeParams","$scope",function(e,t,n,r){if(n.id)var s=e.getEventById(n.id);else t.location.href=e.LIST_EVENTS_URL;r.filterSelected=!0,r.users=e.userService.getAllUsers(),r.selectedUsers=angular.copy(s.guests),r.isSelected=function(e){return r.selectedUsers.find(function(t){return e.email===t.email})},r.addSelected=function(e){r.selectedUsers.push(angular.copy(e))},r.querySearch=function(e){var t=angular.lowercase(e);return r.users.filter(function(e){return-1!=e.email.toLowerCase().indexOf(t)||-1!=e.getName().toLowerCase().indexOf(t)})},r.addGuests=function(){if(n.id){var s=e.getEventById(n.id);s&&(s.guests=r.selectedUsers,e.updateEvents())}t.location.href=e.LIST_EVENTS_URL}}]);